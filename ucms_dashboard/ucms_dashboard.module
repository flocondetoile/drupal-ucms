<?php
/**
 * UCMS - Dashboard and fioritures.
 */

/**
 * Implements hook_menu().
 */
function ucms_dashboard_menu() {

  $items = [];

  $items['admin/dashboard'] = [
    'title'             => "Dashboard",
    'page callback'     => 'ucms_dashboard_page',
    'access arguments'  => ['access administration pages'],
    'type'              => MENU_NORMAL_ITEM,
    'file'              => 'ucms_dashboard.pages.inc',
  ];

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function ucms_dashboard_menu_alter(&$items) {

  // Remove all the unnecessary pages using the 'access administration pages'
  // or whatever else permission the users may have.
  foreach ([
    'admin/compact',
    'admin/config',
    'admin/config/content',
    'admin/config/development',
    'admin/config/media',
    'admin/config/regional',
    'admin/config/search',
    'admin/config/services',
    'admin/config/system',
    'admin/config/user-interface',
    'admin/config/workflow',
    'admin/index',
    'admin/reports/status/rebuild',
    'admin/structure',
  ] as $path) {
    $items[$path]['access arguments'] = ['non existing permission'];
  }

  // Single override where we change the 'admin' home page.
  $items['admin'] = [
    'title'             => "Administration",
    'page callback'     => 'ucms_dashboard_admin_redirect',
    'access arguments'  => ['access administration pages'],
    'type'              => MENU_CALLBACK,
  ];
}

/**
 * Menu callback.
 */
function ucms_dashboard_admin_redirect() {
  drupal_goto('admin/dashboard');
}

/**
 * Implements hook_block_info().
 */
function ucms_dashboard_block_info() {
  return [
    'context' => [
      'info'  => "Contextual pane",
      'cache' => DRUPAL_NO_CACHE,
    ],
  ];
}

/**
 * Get current context pane.
 *
 * @return \MakinaCorpus\Ucms\Dashboard\Context\ContextPane
 *
 * @deprecated
 *   Will be replaced by services one day.
 */
function ucms_dashboard_context_get() {
  return \Drupal::service('ucms_dashboard.context');
}

/**
 * Implements hook_block_view().
 */
function ucms_dashboard_block_view($delta = '') {
  switch ($delta) {

    case 'context':
      $context = ucms_dashboard_context_get();
      if ($context->isEmpty()) {
        if (module_exists('ucms_notification')) {
          $context->add(notification_block_render($GLOBALS['user']));
        } else {
          $context->add(t("Hello"));
        }
      }
      return [
        'content' => [
          '#theme'    => 'ucms_dashboard_context',
          '#items'    => $context->getAll(),
          '#attached' => [
            'css' => [drupal_get_path('module', 'ucms_dashboard') . '/ucms_dashboard.css'],
            'js'  => [drupal_get_path('module', 'ucms_dashboard') . '/ucms_dashboard.js'],
          ],
        ],
      ];
  }
}

/**
 * Implements hook_form_alter().
 */
function ucms_dashboard_form_alter(&$form, &$form_state, &$form_id) {
  if (path_is_admin(current_path()) && isset($form['actions'])) {
    $form['#after_build'][] = 'ucms_dashboard_form_add_actions_to_context';
  }
}

/**
 * All form actions goes to context.
 */
function ucms_dashboard_form_add_actions_to_context($element) {
  $context = ucms_dashboard_context_get();
  // @todo Should add something that works with JS instead
  $context->add($element['actions'], -1000);
  return $element;
}

/**
 * Implements hook_theme().
 */
function ucms_dashboard_theme() {
  return [
    'ucms_dashboard_actions' => [
      'variables' => ['item' => null, 'actions' => []],
    ],
    'ucms_dashboard_context' => [
      'variables' => ['items' => []],
      'template' => 'ucms_dashboard-context',
    ],
    'ucms_dashboard_page' => [
      'variables' => [],
      'template' => 'ucms_dashboard-page',
    ],
    'ucms_dashboard_page_list' => [
      'variables' => [
        'display' => null,
        'filters' => [],
        'items'   => [],
        'search'  => null,
        'pager'   => null,
      ],
      'template' => 'ucms_dashboard-page-list',
    ],
    'ucms_dashboard_top' => [
      'template' => 'ucms_dashboard-top',
    ],
  ];
}

/**
 * Implements hook_page_build().
 */
function ucms_dashboard_page_build(&$page) {
  if (!path_is_admin(current_path())) {
    return;
  }
  $page['page_top']['ucms_dashboard_top'] = [
    '#theme' => 'ucms_dashboard_top',
  ];
}

/**
 * Implements template_preprocess_HOOK().
 */
function template_preprocess_ucms_dashboard_page_list(&$variables) {
  /* @var $display \MakinaCorpus\Ucms\Dashboard\Page\DisplayInterface */
  $display = $variables['display'];
  $variables['displayView']   = $display->render($variables['items']);
  $variables['displayLinks']  = $display->renderLinks();
}

/**
 * Implements theme_HOOK().
 */
function theme_ucms_dashboard_actions($variables) {
  $links = [];
  foreach ($variables['actions'] as $key => $action) {
    /* @var $action \MakinaCorpus\Ucms\Dashboard\Action\Action */
    $links[$key] = $action->getLinkOptions();
    $links[$key]['title'] = $action->getTitle();
    $links[$key]['href'] = $action->getURI();
    if (empty($links[$key]['html'])) {
      $links[$key]['html'] = false; // Avoid some PHP warnings.
    }
  }
  return theme('links__ucms_contrib_actions', ['links' => $links]);
}

parameters:

  # Elastic client configuration, see ElasticSearch\ClientBuilder::fromConfig()
  # factory method doc for extended information about client parameters and
  # behaviors
  ucms_search.elastic.config:
    hosts: ["localhost:9200"]

  # Maps the Drupal index logical names to Elastic Search real indices names
  # keys are Drupal indices names, values are Elastic indices names
  ucms_search.elastic.index_map: []

  # If you set this to true, bulk operations will never be used, this is a
  # workaround because we experienced problems with a misconfigured ES
  # https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-bulk.html
  ucms_search.elastic.never_bulk: false

services:

  ucms_search.index_storage:
    class: MakinaCorpus\Ucms\Search\IndexStorage
    arguments:
      - "@ucms_search.elastic.client"
      - "@database"
      - "@cache.default"
      - "@entity.manager"
      - "@module_handler"
      - "%ucms_search.elastic.index_map%"
      - "%ucms_search.elastic.never_bulk%"

  ucms_search.node_indexer:
    public: false
    class: MakinaCorpus\Ucms\Search\NodeIndexer
    factory: ucms_search.index_storage:indexer

  ucms_search.elastic.client:
    class: Elasticsearch\Client
    factory: [Elasticsearch\ClientBuilder, fromConfig]
    arguments: ["%ucms_search.elastic.config%"]

  ucms_search.search_factory:
    class: MakinaCorpus\Ucms\Search\SearchFactory
    arguments: ["@ucms_search.elastic.client", "@ucms_search.index_storage", "@event_dispatcher"]

  ucms_search.mapping.type_registry:
    class: MakinaCorpus\Ucms\Search\Mapping\TypeRegistry

  ucms_search.mapping.boolean:
    public: false
    class: MakinaCorpus\Ucms\Search\Mapping\BooleanType
    arguments: ["boolean"]
    tags: [{ name: ucms_search.mapping.type }]

  ucms_search.mapping.date:
    public: false
    class: MakinaCorpus\Ucms\Search\Mapping\DateType
    arguments: ["date"]
    tags: [{ name: ucms_search.mapping.type }]

  ucms_search.mapping.integer:
    public: false
    class: MakinaCorpus\Ucms\Search\Mapping\IntegerType
    arguments: ["integer"]
    tags: [{ name: ucms_search.mapping.type }]

  ucms_search.mapping.long:
    public: false
    class: MakinaCorpus\Ucms\Search\Mapping\LongType
    arguments: ["long"]
    tags: [{ name: ucms_search.mapping.type }]

  ucms_search.mapping.string:
    public: false
    class: MakinaCorpus\Ucms\Search\Mapping\StringType
    arguments: ["string"]
    tags: [{ name: ucms_search.mapping.type }]

  ucms_search.event.dequeue_node:
    class: MakinaCorpus\Ucms\Search\EventDispatcher\DequeueNodeEventSubscriber
    arguments: ["@ucms_search.node_indexer"]
    tags: [{ name: event_subscriber}]

  ucms_search.node_access_event_listener:
    class: MakinaCorpus\Ucms\Search\EventDispatcher\SearchAccessEventListener
    tags: [{ name: event_listener, event: ucms_search.search_create }]
